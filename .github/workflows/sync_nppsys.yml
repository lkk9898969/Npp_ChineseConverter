name: Sync Notepad++ Headers

on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯é€±æ—¥ UTC æ™‚é–“ 00:00 åŸ·è¡Œ
  workflow_dispatch:

# è¨­å®šæ¬Šé™ï¼Œç¢ºä¿èƒ½ Push ç¨‹å¼ç¢¼
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest Notepad++ tag
        id: npp-version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ä½¿ç”¨ GitHub CLI æˆ–å¸¶ Token çš„ Curl é¿å… Rate Limit
          # é€™è£¡ä½¿ç”¨å¸¶ Token çš„ curl ç²å–æœ€æ–° Release Tag
          LATEST_TAG=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/notepad-plus-plus/notepad-plus-plus/tags | jq -r '.[0].name')
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest Notepad++ tag: $LATEST_TAG"
          
          # æª¢æŸ¥æœ¬åœ°è¨˜éŒ„çš„ç‰ˆæœ¬ (ä¿®å¾©äº†åŽŸæœ¬çš„è·¯å¾‘ç©ºæ ¼éŒ¯èª¤)
          SYNC_FILE="nppsys/.synced_version"
          if [ -f "$SYNC_FILE" ]; then
            CURRENT_TAG=$(cat "$SYNC_FILE")
            echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
            echo "Current synced tag: $CURRENT_TAG"
          else
            echo "current_tag=none" >> $GITHUB_OUTPUT
            echo "No previous sync found"
          fi

      - name: Check if update needed
        id: check-update
        run: |
          LATEST="${{ steps.npp-version.outputs.latest_tag }}"
          CURRENT="${{ steps.npp-version.outputs.current_tag }}"
          
          # ç¢ºä¿ LATEST ä¸ç‚ºç©ºä¸”ä¸ç­‰æ–¼ null
          if [ -z "$LATEST" ] || [ "$LATEST" == "null" ]; then
            echo "Error: Failed to fetch latest tag."
            exit 1
          fi

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "Status: Update required ($CURRENT -> $LATEST)"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "Status: Up to date ($LATEST)"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Notepad++ source files
        if: steps.check-update.outputs.needs_update == 'true'
        run: |
          TAG="${{ steps.npp-version.outputs.latest_tag }}"
          BASE_URL="https://raw.githubusercontent.com/notepad-plus-plus/notepad-plus-plus/${TAG}"
          TARGET_DIR="nppsys"
          
          mkdir -p "$TARGET_DIR"
          
          # å®šç¾©æª”æ¡ˆå°æ‡‰ (Key: æœ¬åœ°æª”å, Value: é ç«¯è·¯å¾‘)
          declare -A FILES=(
            ["Notepad_plus_msgs.h"]="PowerEditor/src/MISC/PluginsManager/Notepad_plus_msgs.h"
            ["PluginInterface.h"]="PowerEditor/src/MISC/PluginsManager/PluginInterface.h"
            ["Sci_Position.h"]="scintilla/include/Sci_Position.h"
            ["Scintilla.h"]="scintilla/include/Scintilla.h"
            ["menuCmdID.h"]="PowerEditor/src/menuCmdID.h"
          )
          
          echo "### Downloading files for tag: $TAG ###"
          
          has_error=false
          for filename in "${!FILES[@]}"; do
            source_path="${FILES[$filename]}"
            echo "Downloading: $filename"
            
            # ä½¿ç”¨ curl -f å¤±æ•—æ™‚è¿”å›žéŒ¯èª¤ç¢¼
            if curl -s -f "${BASE_URL}/${source_path}" -o "${TARGET_DIR}/${filename}"; then
              echo "âœ“ Success: $filename"
            else
              echo "âœ— Failed: $filename (Source: $source_path)"
              has_error=true
            fi
          done
          
          if [ "$has_error" = true ]; then
            echo "Error: One or more files failed to download."
            exit 1
          fi
          
          # è¨˜éŒ„åŒæ­¥ç‰ˆæœ¬
          echo "$TAG" > "${TARGET_DIR}/.synced_version"
          echo "All files downloaded successfully."

      - name: Commit and push changes
        if: steps.check-update.outputs.needs_update == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add nppsys/
          
          if git diff --staged --quiet; then
            echo "No file changes detected."
          else
            TAG="${{ steps.npp-version.outputs.latest_tag }}"
            git commit -m "chore: sync Notepad++ headers to $TAG"
            git push
            echo "âœ“ Changes pushed to repository."
          fi

      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸ”„ Notepad++ Header Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest Tag | **${{ steps.npp-version.outputs.latest_tag }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Tag | ${{ steps.npp-version.outputs.current_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Update Performed | ${{ steps.check-update.outputs.needs_update }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-update.outputs.needs_update }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Synced Files" >> $GITHUB_STEP_SUMMARY
            echo "- Notepad_plus_msgs.h" >> $GITHUB_STEP_SUMMARY
            echo "- PluginInterface.h" >> $GITHUB_STEP_SUMMARY
            echo "- Sci_Position.h" >> $GITHUB_STEP_SUMMARY
            echo "- Scintilla.h" >> $GITHUB_STEP_SUMMARY
            echo "- menuCmdID.h" >> $GITHUB_STEP_SUMMARY
          fi